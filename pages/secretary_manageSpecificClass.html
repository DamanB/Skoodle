<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="/css/generic.css">
        <link rel="stylesheet" href="/css/main.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script type='text/javascript' src="/js/classes.js"></script>
        <script type='text/javascript' src="/js/data.js"></script>
        <title>Skoodle: Secretary's Manage Specfic Class</title>
    </head>
    
    <body>
        <script>
            var user;
            var toEdit;

            //set header
            $(document).ready(function () {
                getGlobalClassList();
                user = Object.assign(new Secretary, getActiveUser());
                $("#username").text(user.type.toUpperCase() + ": " + user.username);
                $("#name").text("Hello " + user.name + "!");

                function getTeachers() {
                    var emps = getEmployeeList();
                    var teachers = [];
                    emps.forEach(function (emp) {
                        if (emp.type === "Teacher") {
                            teachers.push(emp);
                        }
                    });
                    return teachers;
                 }

                //Populate the teachers field
                var teachers = getTeachers();
                teachers.forEach(function (teach) {
                    var uname = teach.username;
                    var name = teach.name;
                    $("#teacherSelect").append("<option value=" + uname + ">" + uname + "</option>");
                });

                //Get modify data
                toEdit = JSON.parse(sessionStorage.getItem("ModifyClassroom"));
                $("#editClass").text(toEdit.name);
                $("#editTeacher").text(toEdit.teacher.name);
                $("#editTimeInterval").text(toEdit.timeinterval);
                
                //Iterate over class for Student names
                var list = toEdit.ClassList;
                list.forEach(
                    function(studentObj)
                    {
                        $('#studentList tbody').append
                        (
                            '<tr><td>' 
                            + studentObj.name 
                            + '</td><td>' 
                            + studentObj.Stdid
                            + '</td><td>'
                            + '<button id="modStudent">Remove</button> </td></tr>'
                        );
                    }
                );
            });

            //Logout button
            $(document).on('click', "#logout", function(){
                removeActiveUser();
                window.location.href = "/index.html";
            });

            //Edit Class Name
            $(document).on('click', "#modClassName", function()
            {
                var className = $("#newClass").val();

                var valid = true;
                if (!className) 
                {
                    $("#status").text("Enter a valid class name");
                    $("#status").show();
                    valid = false;
                }
                //Duplicate check
                else 
                {
                    var classes = getGlobalClassList();
                    classes.forEach(function (el) {
                        if (el.name.toLowerCase() === className.toLowerCase()) {
                            $("#status").text("Class name already exists");
                            $("#status").show();
                            valid = false;
                            return
                        }
                    })
                }

                if (valid)
                {
                    user.modifyClassName(toEdit.name, className);
                    $("#status").text("Change Success: Class Name");
                    $("#editClass").text(className);
                    toEdit.name = className;
                }
            });

            //Edit Teacher
            $(document).on('click', "#modTeacher", function()
            {
                var newTeacher = $("#teacherSelect").find(":selected").text();
                user.modifyClassTeach(toEdit.name, newTeacher);
                $("#status").text("Change Success: Teacher");
                
                function getTeachers() {
                    var emps = getEmployeeList();
                    var teachers = [];
                    emps.forEach(function (emp) {
                        if (emp.type === "Teacher") {
                            teachers.push(emp);
                        }
                    });
                    return teachers;
                }

                var teachers = getTeachers();
                teachers.forEach(function (teach) {
                    var uname = teach.username;
                    var name = teach.name;
                    if (uname == newTeacher)
                    {
                        toEdit.teacher = teach;
                        $("#editTeacher").text(teach.name);
                    }
                });
            });

            //Edit Time Interval
            //Time Start
            $(document).on('click', "#modTime", function()
            {
                var timeStart = $("#timeStart").val();
                var timeEnd = $("#timeEnd").val();
                var valid = true;

                if (!timeStart)
                {
                    $("#status").text("Enter a valid start time");
                    $("#status").show();
                    valid = false;
                }
                else if (!timeEnd) {
                    $("#status").text("Enter a valid end time");
                    $("#status").show();
                    valid = false;
                }
                else 
                {
                    if (timeStart >= timeEnd) {
                        $("#status").text("The classe's start time must come before the end time");
                        $("#status").show();
                        valid = false;
                    }
                }

                if (valid)
                {
                    var interval = timeStart + " - " + timeEnd;
                    user.modifyClassTime(toEdit.name, interval);
                    toEdit.timeInterval = interval;
                }
            });
            //Remove Student
            $(document).on('click', "#modStudent", function()
            {
                var studID = $(this).parent().prev().text();

                var confirmRemove = confirm("Confirm removal of " + studID + "?");

                if (confirmRemove)
                {
                    user.removeStudentFromClass(toEdit.name, studID);

                    $(this).parent().prev().prev().remove();
                    $(this).parent().prev().remove();
                    this.remove();
                    $("#status").text("Change Success: Remove " + studID);
                }
                else
                {
                    $("#status").text("Change Cancelled");
                }
            });
        </script>

        <div id="logo">
            Skoodle
        </div>

        <div class="nameLabel">
            <span id="username"></span><br>
            <span id="name"></span>
        </div>

        <div id="logout">
            <button>Logout</button>
        </div>

        <br>

        <div id="back">
            <button><a href="/pages/secretary_manageClass.html"
                    style="color: black; text-decoration: none;">Back</a></button>
        </div>

        <br>

        <div id="status">
            Status:
        </div>
        
        <br>

        <div>
            <span>Current Class Name: </span>
            <span id="editClass"></span>

            <br>

            <label for="newClass">New Class Name:</label>
            <input type="text" id="newClass" name="newClass">
            <button id="modClassName">Modify Class Name</button>
        </div>

        <br>

        <div>
            <span>Current Teacher: </span>
            <span id="editTeacher"></span>

            <br>

            <span>Select Teacher:</span>
            <select id="teacherSelect"></select>
            <button id="modTeacher">Modify Teacher</button>
        </div>

        <br><br>

        <div>
            <span>Current Time Interval:</span>
            <span id="editTimeInterval"></span>

            <br>

            <span>Select New Time Intervals:</span>
            <button id="modTime">Modify Time End</button>

            <br>

            <label for="timeStart">Start Time (Hour : Minute : AM/PM)</label><br>
            <input type="time" id="timeStart" name="timeStart">

            <br>

            <label for="timeEnd">End Time (Hour : Minute : AM/PM)</label><br>
            <input type="time" id="timeEnd" name="timeEnd">

        </div>

        <br><br>

        <div>
            <table id="studentList" class="customTable">
                <thead>
                    <th>Student Name</th>
                    <th>Student ID</th>
                </thead>

                <tbody></tbody>
            </table>
        </div>
    </body>
</html>